@using ERPNet.Web.Blazor.Client.Components.Common
@using ERPNet.Web.Blazor.Client.Mcp
@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject McpToolService Mcp


<div class="page">
    <div class="sidebar @(_sidebarCollapsed ? "sidebar-collapsed" : "") offcanvas-md offcanvas-start" tabindex="-1" id="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <button class="btn btn-link text-white p-0 d-md-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#sidebar">
                <i class="bi bi-list fs-4"></i>
            </button>

            <button class="btn btn-link text-white p-0 d-none d-md-flex align-items-center me-auto"
                    @onclick="ToggleSidebar">
                <i class="bi bi-list fs-4"></i>
            </button>

            <a class="navbar-brand text-white m-0 d-md-none" href="">
                <i class="bi bi-box-seam-fill me-2"></i>ERP<span>Net</span>
            </a>

            <!-- BotÃ³n del asistente IA -->
            <button class="btn btn-link text-white p-0 me-3" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#chat-offcanvas"
                    title="Asistente IA">
                <i class="bi bi-robot fs-5"></i>
            </button>

            <div class="dropdown">
                <button class="btn btn-link text-white text-decoration-none dropdown-toggle p-0 d-flex align-items-center gap-2" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle fs-5"></i>
                    @if (_email is not null)
                    {
                        <span class="d-none d-sm-inline" style="font-size:.875rem">@_email</span>
                    }
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/account"><i class="bi bi-person me-2"></i>Mi perfil</a>
                    </li>
                    <li>
                        <hr class="dropdown-divider" />
                    </li>
                    <li>
                        <form method="post" action="/bff/logout">
                            <button type="submit" class="dropdown-item">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                Cerrar sesiÃ³n
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>

        <article class="content px-4 py-4">
            @Body
        </article>
    </main>
</div>

<!-- Offcanvas del asistente IA (se superpone al contenido, la pÃ¡gina activa sigue renderizada) -->
<div class="offcanvas offcanvas-end chat-offcanvas" tabindex="-1" id="chat-offcanvas"
     aria-labelledby="chat-offcanvas-label">
    <div class="offcanvas-header">
        <h6 class="offcanvas-title mb-0" id="chat-offcanvas-label">
            <i class="bi bi-robot me-2"></i>Asistente IA
        </h6>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body p-0">
        <ChatPanel />
    </div>
</div>

<ToastContainer />

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private string? _email;
    private bool _sidebarCollapsed;
    private bool _cleanupPending;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateTask;
        _email = state.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Mcp.InitializeAsync();
            try { await JS.InvokeVoidAsync("chat.registerShortcut"); } catch { }

            try
            {
                var val = await JS.InvokeAsync<string?>("localStorage.getItem", "sidebar-collapsed");
                _sidebarCollapsed = val == "true";
            }
            catch { /* localStorage no disponible (modo privado, storage desactivado) */ }

            _cleanupPending = true;
            StateHasChanged();
        }
        else if (_cleanupPending)
        {
            _cleanupPending = false;
            // El atributo pre-render ya no es necesario: Blazor tiene el estado correcto
            await JS.InvokeVoidAsync("sidebar.removeSidebarInit");
        }
    }

    private async Task ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "sidebar-collapsed", _sidebarCollapsed ? "true" : "false");
        }
        catch { /* localStorage no disponible */ }
    }
}

<div id="blazor-error-ui" data-nosnippet>
    Se produjo un error inesperado
    <a href="." class="reload">Recargar</a>
    <span class="dismiss">ðŸ—™</span>
</div>
