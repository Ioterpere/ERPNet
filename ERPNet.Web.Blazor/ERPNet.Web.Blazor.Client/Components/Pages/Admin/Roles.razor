@page "/roles"
@inherits ErpPage

<PageTitle>Roles — ERPNet</PageTitle>

<div class="row g-0 panel-container">

    <!-- ── Panel izquierdo: Lista ─────────────────────────────── -->
    <div class="col-12 col-lg-3 border-end panel-lista @((!_esNuevo && !Id.HasValue) ? "d-flex" : "d-none d-lg-flex")">

        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between px-3 py-2 border-bottom flex-shrink-0">
            <h5 class="mb-0 fw-semibold">Roles</h5>
            <button class="btn btn-sm btn-primary" @onclick="OnNuevo">
                <i class="bi bi-plus-lg me-1"></i>Nuevo
            </button>
        </div>

        <!-- Buscador -->
        <div class="px-3 py-2 border-bottom flex-shrink-0">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-transparent border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="search" class="form-control border-start-0 ps-0"
                       placeholder="Buscar por nombre..."
                       @bind-value="_busqueda" @bind-value:event="oninput" />
            </div>
        </div>

        <!-- Items -->
        <div class="flex-grow-1 overflow-y-auto">
            @if (_cargandoLista)
            {
                @for (var i = 0; i < 5; i++)
                {
                    <div class="rol-row placeholder-glow">
                        <span class="placeholder col-6 d-block mb-1" style="height:13px"></span>
                        <span class="placeholder col-4" style="height:11px"></span>
                    </div>
                }
            }
            else if (_rolesFiltrados.Count == 0)
            {
                <div class="text-center text-muted py-5 small">
                    <i class="bi bi-shield-x fs-3 d-block mb-2"></i>
                    Sin resultados
                </div>
            }
            else
            {
                @foreach (var r in _rolesFiltrados)
                {
                    <button type="button"
                            class="rol-row w-100 text-start @(Id == r.Id ? "active" : "")"
                            @onclick="() => SeleccionarItem(r.Id)">
                        <div class="fw-semibold text-truncate small">@r.Nombre</div>
                        @if (!string.IsNullOrWhiteSpace(r.Descripcion))
                        {
                            <div class="text-muted text-truncate" style="font-size:.75rem">@r.Descripcion</div>
                        }
                    </button>
                }
            }
        </div>

        <!-- Paginación -->
        @if (_paginado is not null && !_cargandoLista)
        {
            <div class="px-3 py-2 border-top d-flex align-items-center justify-content-between flex-shrink-0 small text-muted">
                <span>@PaginacionTexto</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" @onclick="PaginaAnterior"
                            disabled="@(_pagina <= 1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="PaginaSiguiente"
                            disabled="@(_pagina >= _paginado.TotalPaginas)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- ── Panel derecho: Detalle ─────────────────────────────── -->
    <div class="col-12 col-lg-9 panel-detalle">

        @if (!_esNuevo && !Id.HasValue)
        {
            <!-- Estado vacío -->
            <div class="panel-placeholder">
                <i class="bi bi-shield-lock text-muted" style="font-size:3rem"></i>
                <p class="text-muted mt-3 mb-1">Selecciona un rol de la lista</p>
                <p class="text-muted small mb-0">o crea uno nuevo con el botón "+ Nuevo"</p>
            </div>
        }
        else if (_esNuevo)
        {
            <!-- Formulario de creación -->
            <div class="detail-content">
            <div class="px-4 py-4">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <button class="btn btn-sm btn-light d-lg-none" @onclick="VolverALista">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <h5 class="mb-0 fw-semibold">Nuevo rol</h5>
                </div>

                @if (_errorCrear is not null)
                {
                    <div class="alert alert-danger d-flex align-items-center gap-2 mb-4">
                        <i class="bi bi-x-circle-fill flex-shrink-0"></i>
                        <span>@_errorCrear</span>
                    </div>
                }

                <div class="card mb-3">
                    <div class="card-header d-flex align-items-center gap-2">
                        <i class="bi bi-shield-plus text-primary"></i>
                        <span class="fw-semibold">Datos del rol</span>
                    </div>
                    <div class="card-body py-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @ref="_refNuevoNombre" @bind="_nuevoNombre"
                                       placeholder="Nombre del rol" autocomplete="off" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control" @bind="_nuevoDescripcion"
                                       placeholder="Descripción opcional" autocomplete="off" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-outline-secondary btn-sm" @onclick="VolverALista">Cancelar</button>
                    <button class="btn btn-primary" @onclick="CrearRolAsync" disabled="@_creando">
                        @if (_creando)
                        {
                            <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                        }
                        else
                        {
                            <i class="bi bi-shield-check me-1"></i>
                        }
                        Crear rol
                    </button>
                </div>
            </div>
            </div>
        }
        else if (Id.HasValue)
        {
            <!-- Formulario de edición -->
            <div class="detail-content">
            <div class="px-4 py-4">

                <!-- Header de detalle -->
                <div class="d-flex align-items-center gap-3 mb-4">
                    <button class="btn btn-sm btn-light d-lg-none" @onclick="VolverALista">
                        <i class="bi bi-arrow-left"></i>
                    </button>

                    @if (_cargandoDetalle)
                    {
                        <div class="d-flex align-items-center gap-3 placeholder-glow flex-grow-1">
                            <div>
                                <span class="placeholder d-block mb-1" style="height:14px;width:160px"></span>
                                <span class="placeholder" style="height:11px;width:100px"></span>
                            </div>
                        </div>
                    }
                    else if (_rolDetalle is not null)
                    {
                        <div class="flex-grow-1 overflow-hidden">
                                <h5 class="mb-0 fw-semibold text-truncate">@_rolDetalle.Nombre</h5>
                                @if (!string.IsNullOrWhiteSpace(_rolDetalle.Descripcion))
                                {
                                    <p class="text-muted small mb-0 text-truncate">@_rolDetalle.Descripcion</p>
                                }
                        </div>
                        <button class="btn btn-sm btn-primary flex-shrink-0"
                            @onclick="AbrirModalEditar">
                            <i class="bi bi-pencil"></i>
                        </button> 
                    }
                </div>

                @if (_errorDetalle is not null)
                {
                    <div class="alert alert-danger d-flex align-items-center gap-2 mb-4">
                        <i class="bi bi-exclamation-triangle-fill flex-shrink-0"></i>
                        <span>@_errorDetalle</span>
                    </div>
                }

                @if (!_cargandoDetalle && _rolDetalle is not null)
                {
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <button class="nav-link @(_tabActiva == "usuarios" ? "active" : "")"
                                    @onclick='() => _tabActiva = "usuarios"'>
                                <i class="bi bi-people me-1"></i>Usuarios
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link @(_tabActiva == "permisos" ? "active" : "")"
                                    @onclick='() => _tabActiva = "permisos"'>
                                <i class="bi bi-shield me-1"></i>Permisos
                            </button>
                        </li>
                    </ul>
                    <!-- ── Tab: Usuarios ───────────────────────────── -->
                    @if (_tabActiva == "usuarios")
                    {
                        <div class="card mb-4">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-people text-primary"></i>
                                    <span class="fw-semibold">Usuarios del rol</span>
                                </div>
                                @if (_usuariosEdit.Count > 0)
                                {
                                    <span class="badge bg-primary-subtle text-primary-emphasis">@_usuariosEdit.Count</span>
                                }
                            </div>
                            <div class="card-body">

                                <!-- Añadir usuario -->
                                <div class="d-flex gap-2 mb-3">
                                    <div class="flex-grow-1" style="max-width:400px">
                                        <ItemSelector TItem="UsuarioResponse"
                                                      @key="_selectorKey"
                                                      SearchAsync="BuscarUsuariosAsync"
                                                      GetId="u => u.Id"
                                                      GetLabel="u => u.Email"
                                                      GetSubLabel='u => u.Activo ? "Activo" : "Inactivo"'
                                                      Value="_usuarioParaAnadirId"
                                                      ValueChanged="id => _usuarioParaAnadirId = id"
                                                      Placeholder="Buscar usuario por email..." />
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" @onclick="AñadirUsuario"
                                            disabled="@(_usuarioParaAnadirId is null)">
                                        <i class="bi bi-plus-lg me-1"></i>Añadir
                                    </button>
                                </div>

                                <!-- Lista de usuarios -->
                                @if (_usuariosEdit.Count == 0)
                                {
                                    <div class="text-center text-muted py-4 small">
                                        <i class="bi bi-person-x fs-4 d-block mb-1"></i>
                                        Sin usuarios asignados
                                    </div>
                                }
                                else
                                {
                                    @foreach (var u in _usuariosEdit)
                                    {
                                        <div class="d-flex align-items-center gap-3 py-2 border-bottom">
                                            <div class="user-avatar flex-shrink-0">
                                                @(u.Email.Length > 0 ? char.ToUpper(u.Email[0]).ToString() : "?")
                                            </div>
                                            <div class="flex-grow-1 overflow-hidden">
                                                <div class="small fw-semibold text-truncate">@u.Email</div>
                                            </div>
                                            <a href="/usuarios?id=@u.Id" class="btn btn-sm btn-outline-secondary flex-shrink-0">
                                                <i class="bi bi-arrow-up-right-square"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger flex-shrink-0"
                                                    @onclick="() => QuitarUsuario(u)">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }

                    <!-- ── Tab: Permisos ───────────────────────────── -->
                    else if (_tabActiva == "permisos")
                    {
                        <div class="card mb-4">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-shield-check text-primary"></i>
                                    <span class="fw-semibold">Permisos del rol</span>
                                </div>
                                @if (_permisosEdit.Count > 0)
                                {
                                    <span class="badge bg-primary-subtle text-primary-emphasis">@_permisosEdit.Count</span>
                                }
                            </div>
                            <div class="card-body">

                                <!-- Añadir permiso -->
                                <div class="d-flex gap-2 mb-3">
                                    <select class="form-select form-select-sm" style="max-width:280px"
                                            @bind="_recursoSeleccionadoId">
                                        <option value="0">— Seleccionar recurso —</option>
                                        @foreach (var rec in _recursosDisponibles)
                                        {
                                            <option value="@rec.Id">@rec.Codigo</option>
                                        }
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" @onclick="AñadirPermiso"
                                            disabled="@(_recursoSeleccionadoId == 0)">
                                        <i class="bi bi-plus-lg me-1"></i>Añadir
                                    </button>
                                </div>

                                <!-- Tabla de permisos -->
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Recurso</th>
                                                <th class="text-center" style="width:70px">Crear</th>
                                                <th class="text-center" style="width:70px">Editar</th>
                                                <th class="text-center" style="width:80px">Eliminar</th>
                                                <th style="width:140px">Alcance</th>
                                                <th style="width:50px"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (_permisosEdit.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-4 small">
                                                        <i class="bi bi-shield-slash d-block fs-4 mb-1"></i>
                                                        Sin permisos configurados
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var permiso in _permisosEdit)
                                                {
                                                    <tr>
                                                        <td class="fw-semibold small">@permiso.Codigo</td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input"
                                                                   @bind="permiso.CanCreate" />
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input"
                                                                   @bind="permiso.CanEdit" />
                                                        </td>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input"
                                                                   @bind="permiso.CanDelete" />
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm"
                                                                    @bind="permiso.Alcance">
                                                                <option value="0">Propio</option>
                                                                <option value="1">Sección</option>
                                                                <option value="2">Global</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-danger"
                                                                    @onclick="() => QuitarPermiso(permiso)">
                                                                <i class="bi bi-x-lg"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                }
            </div>
            </div>

            <!-- ── Toolbar de acciones ─────────────────────────── -->
            @if (!_cargandoDetalle && _rolDetalle is not null)
            {
                <div class="detail-toolbar">
                    <button class="btn btn-outline-danger me-auto"
                            @onclick="AbrirModalEliminar">
                        <i class="bi bi-trash3 me-1"></i>Eliminar rol
                    </button>
                    @if (_tabActiva == "usuarios")
                    {
                        @if (_errorUsuarios is not null)
                        {
                            <span class="text-danger small me-auto d-flex align-items-center gap-1">
                                <i class="bi bi-x-circle-fill"></i>@_errorUsuarios
                            </span>
                        }
                        <button class="btn btn-primary" @onclick="GuardarUsuariosAsync"
                                disabled="@_guardandoUsuarios">
                            @if (_guardandoUsuarios)
                            {
                                <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                            }
                            Guardar usuarios
                        </button>
                    }
                    else if (_tabActiva == "permisos")
                    {
                        @if (_errorPermisos is not null)
                        {
                            <span class="text-danger small me-auto d-flex align-items-center gap-1">
                                <i class="bi bi-x-circle-fill"></i>@_errorPermisos
                            </span>
                        }
                        <button class="btn btn-primary" @onclick="GuardarPermisosAsync"
                                disabled="@_guardandoPermisos">
                            @if (_guardandoPermisos)
                            {
                                <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                            }
                            Guardar permisos
                        </button>
                    }
                </div>
            }
        }
    </div>
</div>

<!-- Modal: editar nombre y descripción del rol -->
<Modal Title="Editar rol" @bind-IsVisible="_mostrarModalEditar" CloseOnBackdrop="false">
    <ChildContent>
        @if (_errorDatos is not null)
        {
            <div class="alert alert-danger d-flex align-items-center gap-2 py-2 mb-3">
                <i class="bi bi-x-circle-fill flex-shrink-0"></i>
                <span>@_errorDatos</span>
            </div>
        }
        <div class="row g-3">
            <div class="col-12">
                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" class="form-control" @ref="_refEditNombre" @bind="_editNombre" autocomplete="off" />
            </div>
            <div class="col-12">
                <label class="form-label">Descripción</label>
                <input type="text" class="form-control" @bind="_editDescripcion"
                       placeholder="Descripción opcional" autocomplete="off" />
            </div>
        </div>
    </ChildContent>
    <Footer>
        <button class="btn btn-outline-secondary"
                @onclick='() => _mostrarModalEditar = false'>Cancelar</button>
        <button class="btn btn-primary" @onclick="GuardarDatosAsync" disabled="@_guardandoDatos">
            @if (_guardandoDatos)
            {
                <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
            }
            Guardar cambios
        </button>
    </Footer>
</Modal>

<!-- Modal: confirmar eliminación del rol -->
<Modal Title="Eliminar rol" @bind-IsVisible="_mostrarModalEliminar">
    <ChildContent>
        <p class="mb-1">¿Seguro que quieres eliminar el rol <strong>@_rolDetalle?.Nombre</strong>?</p>
        <p class="text-muted small mb-0">Esta acción no se puede deshacer.</p>
        @if (_errorEliminar is not null)
        {
            <div class="alert alert-danger d-flex align-items-center gap-2 mt-3 py-2 mb-0">
                <i class="bi bi-x-circle-fill flex-shrink-0"></i>
                <span>@_errorEliminar</span>
            </div>
        }
    </ChildContent>
    <Footer>
        <button class="btn btn-outline-secondary"
                @onclick='() => _mostrarModalEliminar = false'>Cancelar</button>
        <button class="btn btn-danger" @ref="_refBtnEliminar" @onclick="EliminarRolAsync" disabled="@_eliminando">
            @if (_eliminando)
            {
                <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
            }
            Eliminar
        </button>
    </Footer>
</Modal>
