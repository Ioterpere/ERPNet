@page "/cambiar-contrasena"
@attribute [Authorize]
@layout EmptyLayout

@inject NavigationManager Nav
@inject IHttpClientFactory Http

<PageTitle>Cambiar contraseña — ERPNet</PageTitle>

<div class="cambiar-contrasena-container">
    <div class="card shadow-lg mx-3" style="width: 100%; max-width: 460px;">
        <div class="card-body p-4">

            <div class="text-center mb-4">
                <i class="bi bi-shield-lock-fill fs-1 text-primary"></i>
                <h4 class="mt-2 fw-bold">Cambio de contraseña obligatorio</h4>
                <p class="text-muted small mb-0">
                    Tu contraseña ha caducado. Debes establecer una nueva antes de continuar.
                </p>
            </div>

            <FormCambiarContrasena OnCambiada="OnContrasenaChangada" />

        </div>
    </div>
</div>

@code {
    private async Task OnContrasenaChangada()
    {
        // Forzar refresh del token y actualizar los claims de la cookie
        // para que requiere_cambio_contrasena pase a false.
        try
        {
            var client = Http.CreateClient("BffInternal");
            await client.PostAsync("/bff/sincronizar-sesion", null);
        }
        catch { /* si falla, el reload hará logout automático */ }

        Nav.NavigateTo("/", forceLoad: true);
    }
}
